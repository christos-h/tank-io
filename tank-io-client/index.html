<!DOCTYPE html>
<html>

<body>

    <canvas id="gameCanvas" width="500" height="500">

    </canvas>
    <script src="./socket.io/socket.io.js"></script>
    <script>
        // Globals
        var id = -1;
        var globalState = null;
        var gameInProgess = false;

        // Socket =======================================================
        var socket = io('http://localhost:3000');
        socket.on('id', function (_id) {
            id = _id;
        });

        socket.on('connect', function () { });

        socket.on('state', function (data) {
            let state = data.filter(state => state.id == id)[0];
            if (state.id == id) {
                x = state.x;
                y = state.y;
                theta = state.theta;
            }
            ctx.clearRect(0, 0, 500, 500);
            data.forEach(tank => {
                renderTank(tank.x, tank.y, tank.theta, tank.color, tank.id);
            });
        });

        socket.on('start', function () {
            gameInProgess = true;
        })

        socket.on('disconnect', function () { });

        socket.on('global', function (_globalState) {
            globalState = _globalState;
            if (!gameInProgess) renderMenu();
        });

        // Canvas / Context =============================================
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // Keys =========================================================    
        var keys = [];

        document.body.addEventListener("keydown", function (e) {
            keys[e.keyCode] = true;
        });
        document.body.addEventListener("keyup", function (e) {
            keys[e.keyCode] = false;
        });

        // Mouse =======================================================
        var mouse = { x: 0, y: 0 };
        canvas.addEventListener('mousemove', function (evt) {
            var rect = canvas.getBoundingClientRect();
            mouse = {
                x: evt.clientX - rect.left,
                y: evt.clientY - rect.top
            };
        }, false);

        // Graphics ====================================================
        var x = 100;
        var y = 100;
        var theta = 0;

        renderMenu();

        function renderMenu() {

            if (globalState != null) {
                ctx.clearRect(0, 0, 500, 500);
                ctx.font = "30px Ariel";
                ctx.fillText('Waiting to join game...', 150, 200);
                ctx.font = "20px Ariel";
                ctx.fillText('Players Online: ' + globalState.nPlayers, 250, 250);
            }
        }

        function renderTank(x, y, theta, color, name) {
            const tankSize = 30;

            renderTracks();
            renderBody()
            renderCannon();
            renderName();

            function renderTracks() {
                ctx.save();
                ctx.beginPath();
                ctx.translate(x, y);
                ctx.rotate(theta)
                ctx.fillStyle = 'black';
                ctx.fillRect(-tankSize / 2, -tankSize / 2, tankSize, tankSize);
                ctx.restore();
            }

            function renderBody() {
                ctx.arc(x, y, (tankSize + 3) / 2, 0, 2 * Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
            }

            function renderCannon() {
                const cannonWidth = 6;
                const cannonLength = 30;
                ctx.save();
                ctx.beginPath();
                ctx.translate(x, y);
                ctx.rotate(getMouseTheta(x, y));
                ctx.fillStyle = 'black';
                ctx.fillRect(-cannonWidth / 2, 0, cannonWidth, cannonLength);
                ctx.restore();
            }

            function getMouseTheta(x, y) {
                return -Math.atan2(mouse.x - x, mouse.y - y);
            }

            function renderName() {
                ctx.font = "14px Ariel";
                ctx.fillStyle = "black"
                ctx.fillText(name, x, y - tankSize);
            }
        }

        function renderBullet(x, y) {
            ctx.arc(x, y, 3, 0, 2 * Math.PI);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.stroke();
        }

        // END =================================================

    </script>
</body>

</html>